name: CI/CD Pipeline - DiÃ¡rio de Bordo Digital

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  test:
    name: ğŸ§ª Testes Automatizados
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: diariobordo_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“¦ Restaurar dependÃªncias
      run: dotnet restore

    - name: ğŸ”¨ Build da soluÃ§Ã£o
      run: dotnet build --no-restore --configuration Release

    - name: ğŸ§ª Testes UnitÃ¡rios - Domain
      run: |
        dotnet test tests/DiarioBordo.Domain.Tests \
          --no-build \
          --configuration Release \
          --logger trx \
          --collect:"XPlat Code Coverage" \
          --results-directory ./test-results/domain

    - name: ğŸ§ª Testes de RepositÃ³rio - Infrastructure
      run: |
        dotnet test tests/DiarioBordo.Infrastructure.Tests \
          --no-build \
          --configuration Release \
          --logger trx \
          --collect:"XPlat Code Coverage" \
          --results-directory ./test-results/infrastructure

    - name: ğŸ§ª Testes de IntegraÃ§Ã£o - API
      env:
        ConnectionStrings__DefaultConnection: "Server=localhost;Port=3306;Database=diariobordo_test;Uid=test_user;Pwd=test_password;"
        ConnectionStrings__Redis: "localhost:6379"
      run: |
        dotnet test tests/DiarioBordo.API.Tests \
          --no-build \
          --configuration Release \
          --logger trx \
          --collect:"XPlat Code Coverage" \
          --results-directory ./test-results/api

    - name: ğŸ“Š Processar relatÃ³rios de cobertura
      uses: danielpalme/ReportGenerator-GitHub-Action@5.2.0
      with:
        reports: './test-results/**/coverage.cobertura.xml'
        targetdir: './coverage-report'
        reporttypes: 'HtmlInline_AzurePipelines;Cobertura;JsonSummary'

    - name: ğŸ“ˆ Upload relatÃ³rio de cobertura
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage-report/Cobertura.xml
        fail_ci_if_error: false

    - name: ğŸ“‹ Publicar resultados dos testes
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: 'Resultados dos Testes'
        path: './test-results/**/*.trx'
        reporter: 'dotnet-trx'

  compliance-check:
    name: ğŸ›ï¸ VerificaÃ§Ã£o de Conformidade ANAC
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: âœ… Verificar 17 campos obrigatÃ³rios Res. 457/2017
      run: |
        echo "ğŸ” Verificando conformidade com ResoluÃ§Ã£o ANAC 457/2017..."
        
        # Executar testes especÃ­ficos de conformidade ANAC
        dotnet test tests/DiarioBordo.Domain.Tests \
          --filter "FullyQualifiedName~AnacCompliance" \
          --logger:"console;verbosity=detailed"
        
        echo "âœ… VerificaÃ§Ã£o de conformidade concluÃ­da"

    - name: ğŸ” Verificar assinaturas digitais Res. 458/2017
      run: |
        echo "ğŸ” Verificando conformidade com ResoluÃ§Ã£o ANAC 458/2017..."
        
        # Executar testes especÃ­ficos de assinatura digital
        dotnet test tests/DiarioBordo.Domain.Tests \
          --filter "FullyQualifiedName~AssinaturaDigital" \
          --logger:"console;verbosity=detailed"
        
        echo "ğŸ” VerificaÃ§Ã£o de assinaturas digitais concluÃ­da"

  security-scan:
    name: ğŸ”’ Scan de SeguranÃ§a
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ” Scan de vulnerabilidades NuGet
      run: |
        dotnet restore
        dotnet list package --vulnerable --include-transitive 2>&1 | tee vulnerability-report.txt
        
        # Falhar se vulnerabilidades crÃ­ticas forem encontradas
        if grep -q "Critical\|High" vulnerability-report.txt; then
          echo "âŒ Vulnerabilidades crÃ­ticas encontradas!"
          exit 1
        else
          echo "âœ… Nenhuma vulnerabilidade crÃ­tica encontrada"
        fi

    - name: ğŸ” Verificar configuraÃ§Ãµes de seguranÃ§a
      run: |
        echo "ğŸ” Verificando configuraÃ§Ãµes de seguranÃ§a..."
        
        # Verificar se hÃ¡ hardcoded secrets
        if grep -r "password\|secret\|key" src/ --include="*.cs" --include="*.json" | grep -v "Password" | grep -v "// TODO\|// FIXME"; then
          echo "âš ï¸ PossÃ­veis secrets hardcoded encontrados"
        else
          echo "âœ… Nenhum secret hardcoded encontrado"
        fi

  performance-test:
    name: âš¡ Testes de Performance
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: diariobordo_perf
          MYSQL_USER: perf_user
          MYSQL_PASSWORD: perf_password
        ports:
          - 3306:3306

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: âš¡ Teste de performance - Consulta 30 dias
      env:
        ConnectionStrings__DefaultConnection: "Server=localhost;Port=3306;Database=diariobordo_perf;Uid=perf_user;Pwd=perf_password;"
      run: |
        echo "âš¡ Testando performance da consulta dos Ãºltimos 30 dias..."
        echo "ğŸ“‹ Requisito: < 500ms conforme Art. 8Âº II Res. 457/2017"
        
        # Executar teste especÃ­fico de performance
        dotnet test tests/DiarioBordo.Infrastructure.Tests \
          --filter "FullyQualifiedName~UltimosTrindaDias" \
          --logger:"console;verbosity=detailed"

  build-docker:
    name: ğŸ³ Build Docker
    runs-on: ubuntu-latest
    needs: [test, compliance-check, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ³ Build imagem Docker
      run: |
        docker build -t diariobordo-api:latest \
          --file src/DiarioBordo.API/Dockerfile \
          --build-arg BUILDVERSION=${{ github.sha }} \
          .

    - name: ğŸ§ª Teste bÃ¡sico da imagem
      run: |
        # Verificar se a imagem foi criada corretamente
        docker images diariobordo-api:latest
        
        # Verificar se o container inicia sem erros
        docker run --rm -d --name test-container \
          -e ASPNETCORE_ENVIRONMENT=Production \
          -p 8080:8080 \
          diariobordo-api:latest &
        
        sleep 10
        
        # Verificar se o healthcheck passa
        if docker ps | grep test-container; then
          echo "âœ… Container executando corretamente"
          docker stop test-container || true
        else
          echo "âŒ Falha ao executar container"
          docker logs test-container || true
          exit 1
        fi

  deployment-staging:
    name: ğŸš€ Deploy Staging
    runs-on: ubuntu-latest
    needs: [build-docker, performance-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: staging

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸš€ Deploy para ambiente de staging
      run: |
        echo "ğŸš€ Deploying para ambiente de staging..."
        echo "ğŸ“‹ VerificaÃ§Ãµes de deployment:"
        echo "  âœ… Testes passaram"
        echo "  âœ… Conformidade ANAC verificada"
        echo "  âœ… Scan de seguranÃ§a passou"
        echo "  âœ… Testes de performance passaram"
        echo "  âœ… Build Docker concluÃ­do"
        echo "ğŸ¯ Deploy simulado com sucesso!"

  notify:
    name: ğŸ“¢ NotificaÃ§Ãµes
    runs-on: ubuntu-latest
    needs: [deployment-staging]
    if: always()

    steps:
    - name: ğŸ“¢ Notificar resultado
      run: |
        if [ "${{ needs.deployment-staging.result }}" = "success" ]; then
          echo "âœ… Pipeline executado com sucesso!"
          echo "ğŸ¯ Sistema DiÃ¡rio de Bordo Digital pronto para produÃ§Ã£o"
          echo "ğŸ›ï¸ Conformidade ANAC 457/2017 e 458/2017 verificada"
        else
          echo "âŒ Pipeline falhou"
          echo "ğŸ” Verificar logs para detalhes"
        fi